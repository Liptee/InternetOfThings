Технология **LoRaWAN** (***Long Range Wide-area Network***).

Технология предназначена для сетей дальнего радиуса действия и связи между устройствами, которые генерируют небольшое количество трафика в день и не требуют большого потребления энергии. Например, эта технология может использоваться для передачи данных телеметрии различных приборов учета (датчиков воды, газа и т.д.) на дальние расстояния.

**LoRaWAN** разработана компанией **Semtech**. Для стандартизации протокола в январе 2015 года был создан LoRa Альянс, в который вошли такие компании, как: **Actillity**, **Cisco**, **Eolane**, **IBM**, **Kerlink**, **IMST**, **MultiTech**, **Sagemcom**, **Semtech**, **Microchip Technolog**, **Лейс (Россия)**.

Технология **LoRa** является широкополосной, работает в безлицензионных диапазонах частот (109 МГц, 433 МГц, 868 МГц, 915 МГц суб-ГГц), имеет низкое энергопотребление (до 10 лет работы от обычных батарей АА), большую дальность связи (15 км в открытой местности и 5 км в плотной городской застройке), а также низкую стоимость оконечных устройств.

Сети **LoRaWAN** используют протокол канального уровня **LoRaWAN** (**MAC** протокол канального уровня), а в качестве протокола фищического уровня - модуляцию LoRa. Архитектура сети представляет собой звезду.

**LoRaWAN** состоит из оконечных узлов *end-nodes* (трансиверов или модулей **LoRa**), представляющих собой беспроводные датчики, которые подключены по радиоинтерфейсу к шлюзам (gateways), сервера сети оператора и сервера приложений сервис провайдера. Шлюзы также иногда называют концетраторами или базовыми станциями. Оконечные устройства часто называют *motes*.

Связь между шлюзами и сервером сети оператора, а также серверами (сети оператора и приложений) осуществляется через стандартные IP-соединения, а между шлюзами и оконечными устройствами - через беспроводные соединения, испольщующие широкополосную модуляцию **LoRa** или частотную **FSK** (***Frequency Shift Keying***). Узлы (*end-nodes*) **LoRaWAN** сети могут быть в зоне покрытия как одного шлюза так и нескольких. Шлюзы имеют способность принимать данные от нескольких усзлов одновременно, поэтому именно эта возможность шлюза напрямую влияет на максимальную плотность узлов на участке местности, обслуживаемой одним шлюзом.
![[Pasted image 20220428140810.png]]
Между компонентами сети "оконечные узлы - сервер сети оператора" используется двусторонняя связь. Базовая станция "слушает" эфир в заданном диапазоне частот. Когда она слышит запрос от какого-либо из устройств, то отвечает ему на частоте обращения. Ширина канала при этом составляет 125 кГц, а скорость передачи данных может меняться от 30 бит/с до 50 кбит/c (т.е. является адаптивной).

В зависимости от радиоусловий в LoRaWAN может выбираться оптимальный набор параметров связи. За этот выбор отвечает *SF-коэффициент* (*Spreading factor*), к которому привязываются параметры передачи и приема. SF - это целое число, значение которого в стандарте предусмотрено от 12 до 7. Чем выше SF, тем лучше помехозащищенность линии, но соответственно ниже скорость и передача данных в эфире занимает больше времени.

В существующих устройствах скорость, фактически, может не превышать 11 килобит в секунду, что вполне достаточно для решаемых данной технологией задач.

После установления канала связи, зашифрованные данные от оконечных узлов принимаются базовой станцией и передаются в сервер сети оператора. Этот сервер отвечает за управление всеми шлюзами, он решает через какой шлюз общаться с датчиком (если датчик "слышно" через несколько шлюзов), производит аутентификацию и проверяет целостность каждого пакета, принимает решение о необходимости изменения скорости передачи данных оконечными узлами, мощности передатчика, выборке канала передачи, ее начале и продолжительности по времени, контролирует заряд батарей конечных узлов, т.е. полностью контролирует всю сеть и управляет каждым устройством в отдельности.

Но сервер сети оператора не обрабатывает полезную информацию пакетов (информацию от датчиков), этим занимается сервер приложений. На сервере приложений (на автономном Web-сайте, либо в "облаке") хранится и расшифровывается информация от датчиков. Затем данные в понятной форме раздаются либо в систему учета стоимости, либо в интерфейс потребителю (польщователи с помощью клиентских приложений, установленных на смартфон или ПК, имеют возможность доступа к информации на сервере приложений), либо в другое заданное место.

В LoRaWAN сетях предусмотрено обязательное двухуровневое шифрование данных двумя разными **AES-128** ключами по стандарту **RFC-4493** для защиты от несанкионированного доступа и искажения либо перехвата данных, передаваемых оконечными устройствами. Обеспечивается полная конфиденциальность данных при прохождении всех задействованных в цепочке устройств, поэтому содержимое пакета доступно только отправителю (оконечному устройству) и получателю, для которого оно предназначено, т.е. приложению сервис-провайдера.

Каждый LoRaWAN пакет данных, отправляемый конечным узлом, имеет в своем составе уникальный идентификатор приложения **AppEUI**, принадлежащий приложению на сервере сервис-провайдера, для которого он предназначен. Этот идентификатор используется сервером сети для дальнейшей маршрутизации пакета и его обработки на сервере приложений. 

Для увеличения емкости сегмента сети возможно масштабирвоание LoRaWAN сети. Более высокая плотность узлов достигается путем установки дополнительных шлюзов. При появлении нового шлюза, сервер сети перераспределяет нагрузку, отправляя конечным узлам "новый график" включения режима передачи.

LoRaWAN - это открытый стандарт. Чипы для конечных устройств существуют в свободной продаже, документация открыта любому желающему.

Конечные узлы передают данные не постоянно, а включают передачу лишь на некоторый промежуток времени (как правило, на 1-5 секунд), по окончании которого открывается временное окно для приема данных. Остальное время трансиверы конечных усзлов находятся либо в неактивном состоянии (*sleep*), либо в состоянии приема, в зависимости от класса устройства (А, В или С).

###### Класс А
Узел передает данные на шлюз короткими посылками по заданному графику. Инициатором обмена выступает сам конечный узел. *End-node* переходит в режим приема (открывает окно приема) на некоторое непродолжительное время сразу после отправки данных, а в остальное, более продолжительное время, он находится в режиме энергосбережения или сна. Сервер накапливает для узла сообщения и пересылает их сразу, как только узел выходит на связь. Узел, как правило, не требует получения подтверждения своего сообщения приложением (сообщение без квитирования), однако протокол предусматривает сообщения, на которые сервер приложений может формировать специальный ответ, "квитанцию" (сообщение с квитированием). Класс узлов А наиболее экономичен в потреблении энергии и наиболее распространен на практике.

###### Класс В
Узел включает приемник по графику, который задается сервером. Инициатором обмена может быть и сервер LoRaWAN сети. Устройства этого класса синхронизируют внутреннее время с временем сети с помощью маяков, которые регулярно получают от шлюза. Ущлы этого класса обладают относительно низкой временной задержкой в обмене данными и открывают более широкое временное окно приема, по сравнению с классом А.

###### Класс С
У узлов этого класса окно приема открыто постоянно и закрывается только на период кратковременной передачи данных. Сервер может инициироват обмен в любое время, и передать сообщения узлу сразу, по мере их поялвения. Этот класс устройств потребляет наибольшее количество энергии, поэтому обычно не использует батарейное питание, но получает данные от сервера **LoRaWAN** сети с наименьшими задержками.